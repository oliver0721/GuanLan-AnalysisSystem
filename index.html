<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§‚æ¾œÂ·èˆ†æƒ…å¤§æ•°æ®ç ”åˆ¤ç³»ç»Ÿ | GuanLan Analysis System</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- å­¦æœ¯ä¸¥è°¨é£æ ¼é…è‰² --- */
        :root {
            --primary-bg: #003366;      /* æµ·å†›è“ */
            --primary-text: #ffffff;
            --main-bg: #f4f6f9;         /* æµ…ç°èƒŒæ™¯ */
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --border: #e2e8f0;
        }

        body { margin: 0; background-color: var(--main-bg); font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; color: var(--text-main); height: 100vh; overflow: hidden; }
        #app { display: flex; height: 100%; width: 100%; }

        /* å·¦ä¾§ä¾§è¾¹æ  */
        .sidebar {
            width: 340px; flex-shrink: 0;
            background-color: var(--primary-bg); color: var(--primary-text);
            display: flex; flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 10;
        }
        .brand-area { padding: 25px; background: rgba(0,0,0,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand-title { font-size: 20px; font-weight: 600; display: flex; align-items: center; letter-spacing: 1px; }
        .config-area { flex: 1; padding: 20px; overflow-y: auto; }

        .glass-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .glass-title { font-size: 13px; font-weight: bold; color: #90cdf4; margin-bottom: 12px; display: flex; align-items: center; }
        .label { font-size: 12px; color: #a0aec0; margin-bottom: 5px; margin-top: 10px; }

        .history-item { padding: 10px; font-size: 13px; color: #cbd5e0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .history-item:hover { background: rgba(255,255,255,0.1); color: #fff; padding-left: 15px; }

        /* å³ä¾§ä¸»åŒºåŸŸ */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--main-bg); min-width: 0; }

        /* é¡¶éƒ¨çƒ­æœ */
        .top-bar { height: 50px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); white-space: nowrap; }
        .hot-label { font-weight: bold; color: #c53030; margin-right: 15px; display: flex; align-items: center; flex-shrink: 0; font-size: 14px; }
        .hot-list { flex: 1; display: flex; align-items: center; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .hot-list::-webkit-scrollbar { display: none; }
        .hot-tag { cursor: pointer; border: 1px solid #ffecec; background: #fff5f5; color: #c53030; font-size: 12px; transition: 0.2s; flex-shrink: 0; }
        .hot-tag:hover { background: #c53030; color: #fff; border-color: #d93025; }

        /* --- æ ¸å¿ƒä¿®å¤ï¼šå·¥ä½œåŒºå¸ƒå±€ --- */
        .work-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            /* å…³é”®ä¿®æ”¹ï¼šç§»é™¤ display: flexï¼Œæ”¹ç”¨é»˜è®¤çš„ block å¸ƒå±€ */
            /* è¿™èƒ½å®Œç¾è§£å†³é•¿å†…å®¹èƒŒæ™¯æˆªæ–­çš„é—®é¢˜ */
            display: block;
            position: relative;
        }

        .search-hero {
            width: 100%;
            max-width: 800px;
            text-align: center;
            /* åœ¨ block å¸ƒå±€ä¸‹ï¼Œä½¿ç”¨ margin: auto å®ç°æ°´å¹³å±…ä¸­ */
            margin: 30px auto;
            transition: all 0.5s;
        }
        .hero-title { font-size: 32px; color: var(--primary-bg); margin-bottom: 30px; font-weight: 700; letter-spacing: 2px; text-align: center; }

        .progress-container { width: 100%; max-width: 800px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #eef1f6; }
        .status-text { text-align: center; margin-top: 20px; color: #606266; font-size: 14px; display: flex; justify-content: center; align-items: center; }

        /* --- æ ¸å¿ƒä¿®å¤ï¼šæŠ¥å‘Šå¡ç‰‡æ ·å¼ --- */
        .report-paper {
            width: 100%;
            max-width: 900px;
            margin: 20px auto; /* ç¡®ä¿å±…ä¸­ */
            background: #fff;
            padding: 60px;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            min-height: 600px;
            border: 1px solid #e2e8f0;
            /* ç¡®ä¿é«˜åº¦è‡ªåŠ¨æ’‘å¼€ */
            height: auto;
            overflow: visible;
        }
        .paper-header { border-bottom: 2px solid var(--primary-bg); padding-bottom: 20px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end; }
        .paper-title { font-size: 24px; font-weight: bold; color: var(--primary-bg); }

        .md-body { font-family: 'Times New Roman', 'SimSun', serif; line-height: 1.8; color: #000; font-size: 16px; }
        .md-body h1, .md-body h2 { font-family: 'Microsoft YaHei', sans-serif; color: var(--primary-bg); border-bottom: 1px solid #eee; margin-top: 30px; }
        .md-body img { max-width: 90%; display: block; margin: 20px auto; border: 1px solid #ddd; padding: 4px; background: #fff; }
        .caption { text-align: center; font-size: 14px; color: #666; font-style: italic; margin-bottom: 30px; }

        .sidebar .el-input__wrapper { background-color: rgba(0,0,0,0.2) !important; box-shadow: none !important; border: 1px solid rgba(255,255,255,0.2) !important; color: #fff; }
        .sidebar .el-input__inner { color: #fff !important; }
        .sidebar .el-select .el-input__wrapper { box-shadow: none !important; }
        .el-select-dropdown__item { font-size: 13px; }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <aside class="sidebar">
            <div class="brand-area" style="display: flex; flex-direction: column; align-items: center;">
                <div class="brand-title" style="justify-content: center;">
                    <el-icon style="margin-right:10px"><School /></el-icon> å¾®åšèˆ†æƒ…ç ”åˆ¤åˆ†æç³»ç»Ÿ
                </div>

                <div style="font-size:12px; opacity:0.6; margin-top:5px; letter-spacing: 0.5px; text-align: center;">
                GuanLan Analysis System
                </div>
            </div>

            <div class="config-area">
                <div class="glass-card">
                    <div class="glass-title"><el-icon style="margin-right:5px"><Cpu /></el-icon> LLM å¼•æ“é…ç½®</div>
                    <div class="label">é€‰æ‹©æ¨¡å‹ (Provider)</div>
                    <el-select v-model="selectedPreset" @change="applyPreset" style="width: 100%" placeholder="ç‚¹å‡»é€‰æ‹©æ¨¡å‹">
                        <el-option-group label="ğŸ‡¨ğŸ‡³ å›½å†…å¤§æ¨¡å‹">
                            <el-option label="ğŸŒ‹ ç«å±±å¼•æ“ (Volcengine)" value="volc"></el-option>
                            <el-option label="ğŸ³ DeepSeek (æ·±åº¦æ±‚ç´¢)" value="deepseek"></el-option>
                            <el-option label="ğŸ¤– æ™ºè°± AI (GLM-4)" value="zhipu"></el-option>
                            <el-option label="ğŸŒ™ Kimi (æœˆä¹‹æš—é¢)" value="kimi"></el-option>
                            <el-option label="ğŸˆ é€šä¹‰åƒé—® (Qwen)" value="qwen"></el-option>
                        </el-option-group>
                        <el-option-group label="ğŸŒ å›½é™…å¤§æ¨¡å‹">
                            <el-option label="ğŸ§  OpenAI (GPT-4o)" value="openai"></el-option>
                            <el-option label="âœ¨ Google Gemini" value="gemini"></el-option>
                            <el-option label="ğŸ­ Anthropic Claude" value="claude"></el-option>
                        </el-option-group>
                    </el-select>
                    <div class="label">API Key</div>
                    <el-input v-model="config.apiKey" type="password" size="small" show-password placeholder="sk-..."></el-input>
                    <div class="label">Model Name</div>
                    <el-input v-model="config.model" size="small"></el-input>
                    <div class="label">Base URL</div>
                    <el-input v-model="config.baseUrl" size="small" placeholder="é»˜è®¤ç•™ç©º"></el-input>
                </div>

                <div class="glass-card">
                    <div class="glass-title"><el-icon style="margin-right:5px"><Key /></el-icon> æ•°æ®æºæˆæƒ</div>
                    <div class="label">å¾®åš Cookie</div>
                    <el-input v-model="config.cookie" type="textarea" :rows="2" size="small" placeholder="ç²˜è´´ Cookie å­—ç¬¦ä¸²"></el-input>
                    <el-button type="primary" size="small" style="width:100%; margin-top:10px; background:#409EFF; border:none;" @click="updateCookie">ä¿å­˜ Cookie</el-button>
                </div>

                <div style="font-weight:bold; font-size:13px; margin-bottom:10px; color:#90cdf4; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                    <el-icon style="margin-right: 5px; vertical-align: middle;"><Files /></el-icon> åˆ†ææ¡£æ¡ˆ
                </div>
                <div v-for="(h, i) in history" :key="i" class="history-item" @click="loadHistory(h)">
                    {{ h.keyword }}
                    <span style="font-size:10px; opacity:0.5; float:right; margin-top: 2px;">{{ h.time }}</span>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="hot-label"><el-icon style="margin-right:5px"><Trend_Charts /></el-icon> å®æ—¶çƒ­æœ</div>
                <div class="hot-list" v-loading="loadingHot">
                    <span v-if="hotList.length === 0" style="font-size:12px; color:#999">æ­£åœ¨å°è¯•è¿æ¥å¾®åšçƒ­æœ...</span>
                    <el-tag v-for="(item, index) in hotList" :key="index" class="hot-tag" effect="plain" round @click="keyword = item.title">
                        {{ index+1 }}. {{ item.title }}
                    </el-tag>
                </div>
            </header>

            <div class="work-area">
                <div class="search-hero">
                    <div class="hero-title">æ–°æµªå¾®åšèˆ†æƒ…å¤§æ•°æ®ç ”åˆ¤å¹³å°</div>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <el-input v-model="keyword" placeholder="è¯·è¾“å…¥è¯é¢˜å…³é”®è¯ æˆ– ç‚¹å‡»ä¸Šæ–¹çƒ­æœ" size="large" style="width:500px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <template #prefix><el-icon><Search /></el-icon></template>
                        </el-input>
                        <el-button type="primary" size="large" @click="startAnalysis" :loading="loading" style="background:var(--primary-bg); padding: 0 30px; font-weight: bold;">
                            ç”Ÿæˆæ·±åº¦æŠ¥å‘Š
                        </el-button>
                    </div>

                    <transition name="fade">
                        <div v-if="loading" class="progress-container">
                            <el-steps :active="activeStep" finish-status="success" align-center>
                                <el-step title="ä¿¡æ¯çˆ¬å–" description="Selenium æ•°æ®é‡‡é›†"></el-step>
                                <el-step title="æ•°æ®æ¸…æ´—" description="NLP æƒ…æ„Ÿè®¡ç®—/ç»˜å›¾"></el-step>
                                <el-step title="AI ç ”åˆ¤" description="LLM æ·±åº¦åˆ†æ"></el-step>
                                <el-step title="æ–‡æ¡£ç”Ÿæˆ" description="Word æŠ¥å‘Šå¯¼å‡º"></el-step>
                            </el-steps>
                            <div class="status-text">
                                <el-icon class="is-loading" style="margin-right: 8px"><Loading /></el-icon>
                                {{ currentStatusText }}
                            </div>
                        </div>
                    </transition>
                </div>

                <transition name="fade">
                    <div v-if="result" class="report-paper">
                        <div class="paper-header">
                            <div class="paper-title">åˆ†ææŠ¥å‘Šï¼š{{ keyword }}</div>
                            <a :href="'/files?path=' + result.doc_path" target="_blank">
                                <el-button type="success" plain icon="Download">ä¸‹è½½ Word æ–‡æ¡£</el-button>
                            </a>
                        </div>
                        <div class="md-body" v-html="markdownToHtml"></div>
                    </div>
                </transition>

                <div style="height: 100px;"></div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const config = reactive({
                    apiKey: localStorage.getItem('api_key') || '',
                    model: localStorage.getItem('model') || '',
                    baseUrl: localStorage.getItem('base_url') || '',
                    cookie: ''
                });

                const selectedPreset = ref('');
                const keyword = ref('');
                const hotList = ref([]);
                const loading = ref(false);
                const loadingHot = ref(false);
                const result = ref(null);
                const history = ref(JSON.parse(localStorage.getItem('history') || '[]'));
                const activeStep = ref(0);
                const currentStatusText = ref('å‡†å¤‡å°±ç»ª');

                const applyPreset = () => {
                    const val = selectedPreset.value;
                    if (val === 'deepseek') {
                        config.model = 'deepseek/deepseek-chat';
                        config.baseUrl = 'https://api.deepseek.com';
                    } else if (val === 'volc') {
                        config.model = 'openai/ep-2025xxxx';
                        config.baseUrl = 'https://ark.cn-beijing.volces.com/api/v3';
                        ElMessage.info('è¯·åœ¨ Model Name ä¸­å¡«å…¥æ‚¨çš„ Endpoint ID');
                    } else if (val === 'openai') {
                        config.model = 'openai/gpt-4o';
                        config.baseUrl = '';
                    } else if (val === 'gemini') {
                        config.model = 'gemini/gemini-pro';
                        config.baseUrl = '';
                    } else if (val === 'claude') {
                        config.model = 'anthropic/claude-3-opus-20240229';
                        config.baseUrl = '';
                    } else if (val === 'zhipu') {
                        config.model = 'zhipu/glm-4';
                        config.baseUrl = '';
                    } else if (val === 'kimi') {
                        config.model = 'moonshot/moonshot-v1-8k';
                        config.baseUrl = '';
                    } else if (val === 'qwen') {
                        config.model = 'dashscope/qwen-turbo';
                        config.baseUrl = '';
                    }
                };

                const fetchHot = async () => {
                    loadingHot.value = true;
                    try {
                        const res = await fetch('/api/hot_search');
                        const data = await res.json();
                        if (data.status === 'success') hotList.value = data.data;
                    } catch (e) { console.error(e); }
                    loadingHot.value = false;
                };

                onMounted(fetchHot);

                const updateCookie = async () => {
                    if(!config.cookie) return ElMessage.warning('Cookie ä¸èƒ½ä¸ºç©º');
                    try {
                        const res = await fetch('/api/update_cookie', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({cookie: config.cookie})
                        });
                        if((await res.json()).status === 'success') ElMessage.success('Cookie å·²æ›´æ–°');
                    } catch(e) { ElMessage.error('æ›´æ–°å¤±è´¥'); }
                };

                const startAnalysis = async () => {
                    if(!keyword.value) return ElMessage.warning('è¯·è¾“å…¥å…³é”®è¯');
                    if(!config.apiKey) return ElMessage.error('API Key ç¼ºå¤±');

                    localStorage.setItem('api_key', config.apiKey);
                    localStorage.setItem('model', config.model);
                    localStorage.setItem('base_url', config.baseUrl);

                    if (!history.value.some(h => h.keyword === keyword.value)) {
                        history.value.unshift({keyword: keyword.value, time: new Date().toLocaleDateString()});
                        localStorage.setItem('history', JSON.stringify(history.value));
                    }

                    loading.value = true;
                    result.value = null;
                    activeStep.value = 1;
                    currentStatusText.value = 'æ­£åœ¨æ¥å…¥å¾®åšæ•°æ®æºï¼Œå¯åŠ¨ Selenium çˆ¬è™«...';

                    const timer = setInterval(() => {
                        if (activeStep.value === 1) {
                            currentStatusText.value = 'æ­£åœ¨ç¿»é¡µæŠ“å–æ•°æ®ï¼Œè§£æ HTML ç»“æ„...';
                            setTimeout(() => { if(loading.value) { activeStep.value = 2; currentStatusText.value = 'çˆ¬å–å®Œæˆï¼Œæ­£åœ¨è¿›è¡Œ NLP æƒ…æ„Ÿæ‰“åˆ†ä¸ç»˜å›¾...'; } }, 15000);
                        } else if (activeStep.value === 2) {
                            setTimeout(() => { if(loading.value) { activeStep.value = 3; currentStatusText.value = 'æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæ·±åº¦ç ”åˆ¤æŠ¥å‘Š...'; } }, 10000);
                        } else if (activeStep.value === 3) {
                            setTimeout(() => { if(loading.value) { activeStep.value = 4; currentStatusText.value = 'æ­£åœ¨æ’ç‰ˆå¹¶ç”Ÿæˆ Word æ–‡æ¡£...'; } }, 10000);
                        }
                    }, 1000);

                    try {
                        const res = await fetch('/api/analyze', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                keyword: keyword.value,
                                api_key: config.apiKey,
                                model: config.model,
                                base_url: config.baseUrl
                            })
                        });
                        const data = await res.json();

                        clearInterval(timer);

                        if(data.status === 'success') {
                            activeStep.value = 5;
                            currentStatusText.value = 'åˆ†æå®Œæˆï¼';
                            result.value = data;
                            ElMessage.success('æŠ¥å‘Šç”ŸæˆæˆåŠŸ');
                        } else {
                            ElMessage.error(data.message);
                            loading.value = false;
                        }
                    } catch(e) {
                        clearInterval(timer);
                        ElMessage.error('è¯·æ±‚å‡ºé”™');
                        loading.value = false;
                    } finally {
                        if (result.value) {
                            setTimeout(() => { loading.value = false; }, 800);
                        }
                    }
                };

                const markdownToHtml = computed(() => {
                    if(!result.value) return '';
                    let text = result.value.analysis;
                    const imgs = result.value.images;

                    const tpl = (src, cap) => `\n\n<div style="text-align:center"><img src="/files?path=${src}" /><div class="caption">${cap}</div></div>\n\n`;

                    if(imgs.sentiment) text = text.replace(/\(æ­¤å¤„æ’å…¥æƒ…æ„Ÿåˆ†å¸ƒå›¾\)/g, tpl(imgs.sentiment, 'å›¾1ï¼šæƒ…æ„Ÿå€¾å‘åˆ†å¸ƒ'));
                    if(imgs.trend) text = text.replace(/\(æ­¤å¤„æ’å…¥è¶‹åŠ¿å›¾\)/g, tpl(imgs.trend, 'å›¾2ï¼šèˆ†æƒ…çƒ­åº¦è¶‹åŠ¿'));
                    if(imgs.wordcloud) text = text.replace(/\(æ­¤å¤„æ’å…¥è¯äº‘å›¾\)/g, tpl(imgs.wordcloud, 'å›¾3ï¼šæ ¸å¿ƒè®®é¢˜è¯äº‘'));

                    return marked.parse(text);
                });

                return { config, selectedPreset, keyword, hotList, loading, loadingHot, result, history, activeStep, currentStatusText, applyPreset, updateCookie, startAnalysis, markdownToHtml, loadHistory: (h)=>keyword.value=h.keyword };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>